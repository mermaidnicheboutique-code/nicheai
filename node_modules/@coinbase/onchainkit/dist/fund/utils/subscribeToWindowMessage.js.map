{"version":3,"file":"subscribeToWindowMessage.js","sources":["../../../src/fund/utils/subscribeToWindowMessage.ts"],"sourcesContent":["import { DEFAULT_ONRAMP_URL } from '../constants';\nimport type { JsonObject } from '../types';\n\nexport const MessageCodes = {\n  AppParams: 'app_params',\n  PaymentLinkSuccess: 'payment_link_success',\n  PaymentLinkClosed: 'payment_link_closed',\n  GuestCheckoutRedirectSuccess: 'guest_checkout_redirect_success',\n  Success: 'success',\n  Event: 'event',\n} as const;\nexport type MessageCodesType = (typeof MessageCodes)[keyof typeof MessageCodes];\n\ntype MessageData = JsonObject;\n\n/**\n * Subscribes to a message from the parent window.\n * @param messageCode A message code to subscribe to.\n * @param onMessage Callback for when the message is received.\n * @param allowedOrigin The origin to allow messages from.\n * @param onValidateOrigin Callback to validate the origin of the message.\n * @returns\n */\nexport function subscribeToWindowMessage({\n  onMessage,\n  allowedOrigin = DEFAULT_ONRAMP_URL,\n  onValidateOrigin = () => Promise.resolve(true),\n}: {\n  onMessage: (data?: MessageData) => void;\n  allowedOrigin: string;\n  onValidateOrigin?: (origin: string) => Promise<boolean>;\n}) {\n  const handleMessage = (event: MessageEvent<string>) => {\n    if (!isAllowedOrigin({ event, allowedOrigin })) {\n      return;\n    }\n\n    const { eventName, data } = JSON.parse(event.data);\n\n    if (eventName === 'event') {\n      (async () => {\n        if (await onValidateOrigin(event.origin)) {\n          onMessage(data);\n        }\n      })();\n    }\n  };\n\n  window.addEventListener('message', handleMessage);\n\n  // Unsubscribe\n  return () => {\n    window.removeEventListener('message', handleMessage);\n  };\n}\n\nfunction isAllowedOrigin({\n  event,\n  allowedOrigin,\n}: {\n  event: MessageEvent;\n  allowedOrigin: string;\n}) {\n  const isOriginAllowed = !allowedOrigin || event.origin === allowedOrigin;\n  return isOriginAllowed;\n}\n"],"names":["MessageCodes","AppParams","PaymentLinkSuccess","PaymentLinkClosed","GuestCheckoutRedirectSuccess","Success","Event","subscribeToWindowMessage","onMessage","allowedOrigin","DEFAULT_ONRAMP_URL","onValidateOrigin","Promise","resolve","handleMessage","event","isAllowedOrigin","eventName","data","JSON","parse","origin","addEventListener","removeEventListener","isOriginAllowed"],"mappings":";AAGO,MAAMA,eAAe;AAAA,EAC1BC,WAAW;AAAA,EACXC,oBAAoB;AAAA,EACpBC,mBAAmB;AAAA,EACnBC,8BAA8B;AAAA,EAC9BC,SAAS;AAAA,EACTC,OAAO;AACT;AAaO,SAASC,yBAAyB;AAAA,EACvCC;AAAAA,EACAC,gBAAgBC;AAAAA,EAChBC,mBAAmBA,MAAMC,QAAQC,QAAQ,IAAI;AAK/C,GAAG;AACKC,QAAAA,gBAAgBA,CAACC,UAAgC;AACrD,QAAI,CAACC,gBAAgB;AAAA,MAAED;AAAAA,MAAON;AAAAA,IAAAA,CAAe,GAAG;AAC9C;AAAA,IAAA;AAGI,UAAA;AAAA,MAAEQ;AAAAA,MAAWC;AAAAA,IAASC,IAAAA,KAAKC,MAAML,MAAMG,IAAI;AAEjD,QAAID,cAAc,SAAS;AACzB,OAAC,YAAY;AACX,YAAI,MAAMN,iBAAiBI,MAAMM,MAAM,GAAG;AACxCb,oBAAUU,IAAI;AAAA,QAAA;AAAA,MAChB,GACC;AAAA,IAAA;AAAA,EAEP;AAEOI,SAAAA,iBAAiB,WAAWR,aAAa;AAGhD,SAAO,MAAM;AACJS,WAAAA,oBAAoB,WAAWT,aAAa;AAAA,EACrD;AACF;AAEA,SAASE,gBAAgB;AAAA,EACvBD;AAAAA,EACAN;AAIF,GAAG;AACD,QAAMe,kBAAkB,CAACf,iBAAiBM,MAAMM,WAAWZ;AACpDe,SAAAA;AACT;"}