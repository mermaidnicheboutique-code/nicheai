{"version":3,"file":"useMorphoVault.js","sources":["../../../src/earn/hooks/useMorphoVault.ts"],"sourcesContent":["'use client';\nimport { MORPHO_VAULT_ABI } from '@/earn/abis/morpho';\nimport { MORPHO_TOKEN_BASE_ADDRESS } from '@/earn/constants';\nimport calculateMorphoRewards from '@/earn/utils/calculateMorphoRewards';\nimport { fetchMorphoApy } from '@/earn/utils/fetchMorphoApy';\nimport { useQuery } from '@tanstack/react-query';\nimport { type Address, formatUnits } from 'viem';\nimport { base } from 'viem/chains';\nimport { useReadContract, useReadContracts } from 'wagmi';\n\nexport type UseMorphoVaultParams = {\n  vaultAddress: Address;\n  recipientAddress?: Address;\n};\n\nexport type UseMorphoVaultReturnType = {\n  vaultName: string | undefined;\n  status: 'pending' | 'success' | 'error';\n  /** Warns users if vault address is invalid */\n  error: Error | null;\n  /** Underlying asset of the vault */\n  asset: {\n    address: Address;\n    symbol: string | undefined;\n    decimals: number | undefined;\n  };\n  /** User's deposits in the vault, adjusted for decimals */\n  balance: string | undefined;\n  balanceStatus: 'pending' | 'success' | 'error';\n  refetchBalance: () => void;\n  /** Total net APY of the vault after all rewards and fees */\n  totalApy: number | undefined;\n  /** Native rewards of the vault (e.g. USDC if the asset is USDC) */\n  nativeApy: number | undefined;\n  /** Additional rewards (e.g. MORPHO) */\n  rewards:\n    | Array<{\n        asset: Address;\n        assetName: string;\n        apy: number;\n      }>\n    | undefined;\n  /** Vault fee, in percent (e.g. 0.03 for 3%) */\n  vaultFee: number | undefined;\n  /** Number of decimals of the vault's share tokens (not underlying asset) */\n  vaultDecimals: number | undefined;\n  /** Total deposits in the vault */\n  deposits: string | undefined;\n  /** Total liquidity available to borrow in the vault */\n  liquidity: string | undefined;\n};\n\n// eslint-disable-next-line complexity\nexport function useMorphoVault({\n  vaultAddress,\n  recipientAddress,\n}: UseMorphoVaultParams): UseMorphoVaultReturnType {\n  const { data, status } = useReadContracts({\n    contracts: [\n      {\n        abi: MORPHO_VAULT_ABI,\n        address: vaultAddress,\n        functionName: 'asset',\n        chainId: base.id, // Only Base is supported\n      },\n      {\n        abi: MORPHO_VAULT_ABI,\n        address: vaultAddress,\n        functionName: 'name',\n        chainId: base.id, // Only Base is supported\n      },\n      {\n        abi: MORPHO_VAULT_ABI,\n        address: vaultAddress,\n        functionName: 'decimals',\n        chainId: base.id, // Only Base is supported\n      },\n    ],\n    query: {\n      enabled: !!vaultAddress,\n    },\n  });\n\n  const assetAddress = data?.[0].result;\n  const vaultName = data?.[1].result;\n  const vaultDecimals = data?.[2].result;\n\n  // Fetching separately because user may not be connected\n  const {\n    data: balance,\n    status: balanceStatus,\n    refetch,\n  } = useReadContract({\n    abi: MORPHO_VAULT_ABI,\n    address: vaultAddress,\n    functionName: 'maxWithdraw',\n    args: [recipientAddress as Address],\n    chainId: base.id, // Only Base is supported\n    query: {\n      enabled: !!vaultAddress && !!recipientAddress,\n    },\n  });\n\n  const { data: vaultData, error } = useQuery({\n    queryKey: ['morpho-apy', vaultAddress],\n    queryFn: () => fetchMorphoApy(vaultAddress),\n  });\n\n  const morphoApr = vaultData?.state\n    ? calculateMorphoRewards(vaultData?.state)\n    : 0;\n\n  const formattedBalance =\n    balance && vaultData?.asset?.decimals\n      ? formatUnits(balance, vaultData?.asset.decimals)\n      : undefined;\n\n  const formattedDeposits =\n    vaultData?.state?.totalAssets && vaultData?.asset?.decimals\n      ? formatUnits(\n          BigInt(vaultData.state.totalAssets),\n          vaultData.asset.decimals,\n        )\n      : undefined;\n\n  const formattedLiquidity =\n    vaultData?.liquidity?.underlying && vaultData?.asset?.decimals\n      ? formatUnits(\n          BigInt(vaultData.liquidity.underlying),\n          vaultData.asset.decimals,\n        )\n      : undefined;\n\n  return {\n    status,\n    error,\n    /** Balance is the amount of the underlying asset that the user has in the vault */\n    balance: formattedBalance,\n    balanceStatus,\n    refetchBalance: refetch,\n    asset: {\n      address: assetAddress as Address,\n      symbol: vaultData?.symbol,\n      decimals: vaultData?.asset.decimals,\n    },\n    vaultName,\n    vaultDecimals,\n    totalApy: vaultData?.state?.netApy,\n    nativeApy: vaultData?.state?.netApyWithoutRewards,\n    vaultFee: vaultData?.state?.fee,\n    deposits: formattedDeposits,\n    liquidity: formattedLiquidity,\n    rewards: [\n      {\n        asset: MORPHO_TOKEN_BASE_ADDRESS,\n        assetName: 'MORPHO',\n        apy: morphoApr,\n      },\n      ...(vaultData?.state?.rewards.map((reward) => ({\n        asset: reward.asset.address,\n        assetName: reward.asset.name,\n        apy: reward.supplyApr,\n      })) || []),\n    ],\n  };\n}\n"],"names":["useMorphoVault","vaultAddress","recipientAddress","data","status","useReadContracts","contracts","abi","MORPHO_VAULT_ABI","address","functionName","chainId","base","id","query","enabled","assetAddress","result","vaultName","vaultDecimals","balance","balanceStatus","refetch","useReadContract","args","vaultData","error","useQuery","queryKey","queryFn","fetchMorphoApy","morphoApr","state","calculateMorphoRewards","formattedBalance","asset","decimals","formatUnits","undefined","formattedDeposits","totalAssets","BigInt","formattedLiquidity","liquidity","underlying","refetchBalance","symbol","totalApy","netApy","nativeApy","netApyWithoutRewards","vaultFee","fee","deposits","rewards","MORPHO_TOKEN_BASE_ADDRESS","assetName","apy","map","reward","name","supplyApr"],"mappings":";;;;;;;;AAqDO,SAASA,eAAe;AAAA,EAC7BC;AAAAA,EACAC;AACoB,GAA6B;;AAC3C,QAAA;AAAA,IAAEC;AAAAA,IAAMC;AAAAA,MAAWC,iBAAiB;AAAA,IACxCC,WAAW,CACT;AAAA,MACEC,KAAKC;AAAAA,MACLC,SAASR;AAAAA,MACTS,cAAc;AAAA,MACdC,SAASC,KAAKC;AAAAA;AAAAA,IAAAA,GAEhB;AAAA,MACEN,KAAKC;AAAAA,MACLC,SAASR;AAAAA,MACTS,cAAc;AAAA,MACdC,SAASC,KAAKC;AAAAA;AAAAA,IAAAA,GAEhB;AAAA,MACEN,KAAKC;AAAAA,MACLC,SAASR;AAAAA,MACTS,cAAc;AAAA,MACdC,SAASC,KAAKC;AAAAA;AAAAA,IAAAA,CACf;AAAA,IAEHC,OAAO;AAAA,MACLC,SAAS,CAAC,CAACd;AAAAA,IAAAA;AAAAA,EACb,CACD;AAEKe,QAAAA,eAAeb,6BAAO,GAAGc;AACzBC,QAAAA,YAAYf,6BAAO,GAAGc;AACtBE,QAAAA,gBAAgBhB,6BAAO,GAAGc;AAG1B,QAAA;AAAA,IACJd,MAAMiB;AAAAA,IACNhB,QAAQiB;AAAAA,IACRC;AAAAA,MACEC,gBAAgB;AAAA,IAClBhB,KAAKC;AAAAA,IACLC,SAASR;AAAAA,IACTS,cAAc;AAAA,IACdc,MAAM,CAACtB,gBAA2B;AAAA,IAClCS,SAASC,KAAKC;AAAAA;AAAAA,IACdC,OAAO;AAAA,MACLC,SAAS,CAAC,CAACd,gBAAgB,CAAC,CAACC;AAAAA,IAAAA;AAAAA,EAC/B,CACD;AAEK,QAAA;AAAA,IAAEC,MAAMsB;AAAAA,IAAWC;AAAAA,MAAUC,SAAS;AAAA,IAC1CC,UAAU,CAAC,cAAc3B,YAAY;AAAA,IACrC4B,SAASA,MAAMC,eAAe7B,YAAY;AAAA,EAAA,CAC3C;AAED,QAAM8B,aAAYN,uCAAWO,SACzBC,uBAAuBR,uCAAWO,KAAK,IACvC;AAEEE,QAAAA,mBACJd,aAAWK,4CAAWU,UAAXV,mBAAkBW,YACzBC,YAAYjB,SAASK,uCAAWU,MAAMC,QAAQ,IAC9CE;AAEN,QAAMC,sBACJd,4CAAWO,UAAXP,mBAAkBe,kBAAef,4CAAWU,UAAXV,mBAAkBW,YAC/CC,YACEI,OAAOhB,UAAUO,MAAMQ,WAAW,GAClCf,UAAUU,MAAMC,QAClB,IACAE;AAEN,QAAMI,uBACJjB,4CAAWkB,cAAXlB,mBAAsBmB,iBAAcnB,4CAAWU,UAAXV,mBAAkBW,YAClDC,YACEI,OAAOhB,UAAUkB,UAAUC,UAAU,GACrCnB,UAAUU,MAAMC,QAClB,IACAE;AAEC,SAAA;AAAA,IACLlC;AAAAA,IACAsB;AAAAA;AAAAA,IAEAN,SAASc;AAAAA,IACTb;AAAAA,IACAwB,gBAAgBvB;AAAAA,IAChBa,OAAO;AAAA,MACL1B,SAASO;AAAAA,MACT8B,QAAQrB,uCAAWqB;AAAAA,MACnBV,UAAUX,uCAAWU,MAAMC;AAAAA,IAC7B;AAAA,IACAlB;AAAAA,IACAC;AAAAA,IACA4B,WAAUtB,4CAAWO,UAAXP,mBAAkBuB;AAAAA,IAC5BC,YAAWxB,4CAAWO,UAAXP,mBAAkByB;AAAAA,IAC7BC,WAAU1B,4CAAWO,UAAXP,mBAAkB2B;AAAAA,IAC5BC,UAAUd;AAAAA,IACVI,WAAWD;AAAAA,IACXY,SAAS,CACP;AAAA,MACEnB,OAAOoB;AAAAA,MACPC,WAAW;AAAA,MACXC,KAAK1B;AAAAA,IAAAA,GAEP,KAAIN,4CAAWO,UAAXP,mBAAkB6B,QAAQI,IAAKC,CAAY,YAAA;AAAA,MAC7CxB,OAAOwB,OAAOxB,MAAM1B;AAAAA,MACpB+C,WAAWG,OAAOxB,MAAMyB;AAAAA,MACxBH,KAAKE,OAAOE;AAAAA,IACd,QAAO,CAAG,CAAA;AAAA,EAEd;AACF;"}