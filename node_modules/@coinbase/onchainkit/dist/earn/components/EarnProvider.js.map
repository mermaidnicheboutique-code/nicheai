{"version":3,"file":"EarnProvider.js","sources":["../../../src/earn/components/EarnProvider.tsx"],"sourcesContent":["'use client';\nimport { useBuildDepositToMorphoTx } from '@/earn/hooks/useBuildDepositToMorphoTx';\nimport { getToken } from '@/earn/utils/getToken';\nimport { useLifecycleStatus } from '@/internal/hooks/useLifecycleStatus';\nimport { useGetTokenBalance } from '@/wallet/hooks/useGetTokenBalance';\nimport {\n  createContext,\n  useCallback,\n  useContext,\n  useEffect,\n  useMemo,\n  useState,\n} from 'react';\nimport { useAccount } from 'wagmi';\nimport { useBuildWithdrawFromMorphoTx } from '../hooks/useBuildWithdrawFromMorphoTx';\nimport { useMorphoVault } from '../hooks/useMorphoVault';\nimport type {\n  EarnContextType,\n  EarnProviderProps,\n  LifecycleStatus,\n} from '../types';\n\nconst EarnContext = createContext<EarnContextType | undefined>(undefined);\n\nexport function EarnProvider({\n  vaultAddress,\n  children,\n  isSponsored,\n  onError,\n  onStatus,\n  onSuccess,\n}: EarnProviderProps) {\n  if (!vaultAddress) {\n    throw new Error(\n      'vaultAddress is required. For a list of vaults, see: https://app.morpho.org/base/earn',\n    );\n  }\n\n  const [lifecycleStatus, updateLifecycleStatus] =\n    useLifecycleStatus<LifecycleStatus>({\n      statusName: 'init',\n      statusData: null,\n    });\n\n  const { address } = useAccount();\n\n  const [withdrawAmount, setWithdrawAmount] = useState('');\n  const [depositAmount, setDepositAmount] = useState('');\n\n  useEffect(() => {\n    if (lifecycleStatus.statusName === 'error') {\n      onError?.(lifecycleStatus.statusData);\n    }\n    if (lifecycleStatus?.statusName === 'success') {\n      onSuccess?.(lifecycleStatus?.statusData?.transactionReceipts?.[0]);\n    }\n    onStatus?.(lifecycleStatus);\n  }, [lifecycleStatus, onStatus, onError, onSuccess]);\n\n  const {\n    asset,\n    balance: depositedBalance,\n    balanceStatus: depositedBalanceStatus,\n    refetchBalance: refetchDepositedBalance,\n    totalApy,\n    nativeApy,\n    vaultFee,\n    vaultName,\n    deposits,\n    liquidity,\n    rewards,\n    error,\n  } = useMorphoVault({\n    vaultAddress,\n    recipientAddress: address,\n  });\n\n  const vaultToken = asset\n    ? getToken({\n        address: asset.address,\n        symbol: asset.symbol,\n        name: asset.symbol,\n        decimals: asset.decimals,\n      })\n    : undefined;\n\n  const {\n    convertedBalance: walletBalance,\n    status: walletBalanceStatus,\n    refetch: refetchWalletBalance,\n  } = useGetTokenBalance(address, vaultToken);\n\n  const { calls: depositCalls } = useBuildDepositToMorphoTx({\n    vaultAddress,\n    amount: depositAmount,\n    recipientAddress: address,\n  });\n\n  const { calls: withdrawCalls } = useBuildWithdrawFromMorphoTx({\n    vaultAddress,\n    amount: withdrawAmount,\n    recipientAddress: address,\n    tokenDecimals: vaultToken?.decimals,\n  });\n\n  // Lifecycle statuses\n  const handleDepositAmount = useCallback(\n    async (amount: string) => {\n      updateLifecycleStatus({\n        statusName: 'amountChange',\n        statusData: { amount: amount, token: vaultToken },\n      });\n\n      setDepositAmount(amount);\n    },\n    [updateLifecycleStatus, vaultToken],\n  );\n\n  const handleWithdrawAmount = useCallback(\n    async (amount: string) => {\n      updateLifecycleStatus({\n        statusName: 'amountChange',\n        statusData: { amount: amount, token: vaultToken },\n      });\n\n      setWithdrawAmount(amount);\n    },\n    [updateLifecycleStatus, vaultToken],\n  );\n\n  // Validating input amounts\n  const depositAmountError = useMemo(() => {\n    if (!depositAmount) {\n      return null;\n    }\n    if (Number(depositAmount) <= 0) {\n      return 'Must be greater than 0';\n    }\n    if (Number(depositAmount) > Number(walletBalance)) {\n      return 'Amount exceeds the balance';\n    }\n    return null;\n  }, [depositAmount, walletBalance]);\n\n  const withdrawAmountError = useMemo(() => {\n    if (!withdrawAmount) {\n      return null;\n    }\n    if (Number(withdrawAmount) === 0) {\n      return 'Must be greater than 0';\n    }\n    if (Number(withdrawAmount) > Number(depositedBalance)) {\n      return 'Amount exceeds the balance';\n    }\n    return null;\n  }, [withdrawAmount, depositedBalance]);\n\n  return (\n    <EarnContext.Provider\n      value={{\n        error,\n        recipientAddress: address,\n        vaultAddress,\n        vaultToken,\n        vaultName,\n        deposits,\n        liquidity,\n        depositedBalance,\n        depositedBalanceStatus,\n        refetchDepositedBalance,\n        depositAmount,\n        setDepositAmount: handleDepositAmount,\n        depositAmountError,\n        withdrawAmount,\n        setWithdrawAmount: handleWithdrawAmount,\n        withdrawAmountError,\n        walletBalance,\n        walletBalanceStatus,\n        refetchWalletBalance,\n        apy: totalApy,\n        nativeApy,\n        vaultFee,\n        rewards,\n        // TODO: update when we have logic to fetch interest\n        interestEarned: '',\n        withdrawCalls,\n        depositCalls,\n        lifecycleStatus,\n        updateLifecycleStatus,\n        isSponsored,\n      }}\n    >\n      {children}\n    </EarnContext.Provider>\n  );\n}\n\nexport function useEarnContext() {\n  const context = useContext(EarnContext);\n  if (!context) {\n    throw new Error('useEarnContext must be used within an EarnProvider');\n  }\n  return context;\n}\n"],"names":["EarnContext","createContext","undefined","EarnProvider","vaultAddress","children","isSponsored","onError","onStatus","onSuccess","Error","lifecycleStatus","updateLifecycleStatus","useLifecycleStatus","statusName","statusData","address","useAccount","withdrawAmount","setWithdrawAmount","useState","depositAmount","setDepositAmount","useEffect","transactionReceipts","asset","balance","depositedBalance","balanceStatus","depositedBalanceStatus","refetchBalance","refetchDepositedBalance","totalApy","nativeApy","vaultFee","vaultName","deposits","liquidity","rewards","error","useMorphoVault","recipientAddress","vaultToken","getToken","symbol","name","decimals","convertedBalance","walletBalance","status","walletBalanceStatus","refetch","refetchWalletBalance","useGetTokenBalance","calls","depositCalls","useBuildDepositToMorphoTx","amount","withdrawCalls","useBuildWithdrawFromMorphoTx","tokenDecimals","handleDepositAmount","useCallback","token","handleWithdrawAmount","depositAmountError","useMemo","Number","withdrawAmountError","apy","interestEarned","useEarnContext","context","useContext"],"mappings":"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"}