{"version":3,"file":"AppchainBridgeProvider.js","sources":["../../../../src/appchain/bridge/components/AppchainBridgeProvider.tsx"],"sourcesContent":["'use client';\n\n/* eslint-disable react-hooks/rules-of-hooks */\nimport { getChainExplorer } from '@/core/network/getChainExplorer';\nimport { useValue } from '@/internal/hooks/useValue';\nimport { baseSvg } from '@/internal/svg/baseSvg';\nimport { coinbaseLogoSvg } from '@/internal/svg/coinbaseLogoSvg';\nimport type { Token } from '@/token';\nimport {\n  createContext,\n  useCallback,\n  useContext,\n  useEffect,\n  useState,\n} from 'react';\nimport { type Address, type Hex, erc20Abi, formatUnits } from 'viem';\nimport { useAccount, useConfig } from 'wagmi';\nimport { getBalance, readContract } from 'wagmi/actions';\nimport { DEFAULT_BRIDGEABLE_TOKENS } from '../constants';\nimport { useChainConfig } from '../hooks/useAppchainConfig';\nimport { useDeposit } from '../hooks/useDeposit';\nimport { useWithdraw } from '../hooks/useWithdraw';\nimport type { ChainWithIcon } from '../types';\nimport type { BridgeParams } from '../types';\nimport type { AppchainBridgeContextType } from '../types';\nimport type { AppchainBridgeProviderProps } from '../types';\nimport { defaultPriceFetcher } from '../utils/defaultPriceFetcher';\n\nconst AppchainBridgeContext = createContext<\n  AppchainBridgeContextType | undefined\n>(undefined);\n\nexport const AppchainBridgeProvider = ({\n  children,\n  chain,\n  appchain,\n  bridgeableTokens = DEFAULT_BRIDGEABLE_TOKENS,\n  handleFetchPrice = defaultPriceFetcher,\n}: AppchainBridgeProviderProps) => {\n  // Source network\n  const [from, setFrom] = useState<ChainWithIcon>({\n    ...chain,\n    icon: baseSvg,\n  });\n  // Destination network\n  const [to, setTo] = useState<ChainWithIcon>({\n    ...appchain.chain,\n    icon: appchain.icon || coinbaseLogoSvg,\n  });\n  // op-enclave configuration https://github.com/base/op-enclave/blob/main/contracts/src/DeployChain.sol\n  const { config, error } = useChainConfig({\n    l2ChainId: chain.id,\n    appchainChainId: appchain.chain.id,\n  });\n\n  if (error) {\n    console.error(error);\n    throw new Error(\n      'Error loading chain configuration. Ensure you have the correct chain ID.',\n    );\n  }\n  if (bridgeableTokens.length === 0) {\n    throw new Error(\n      'Bridgeable tokens must be provided as a parameter to AppchainBridge.',\n    );\n  }\n  if (!config) {\n    return null;\n  }\n\n  // Wagmi hooks\n  const { address } = useAccount();\n  const wagmiConfig = useConfig();\n\n  // Bridge params\n  const [bridgeParams, setBridgeParams] = useState<BridgeParams>({\n    amount: '',\n    amountUSD: '0.00',\n    token: bridgeableTokens[0],\n    recipient: address,\n  });\n\n  // Bridge state\n  const [isPriceLoading, setIsPriceLoading] = useState(false);\n  const [isAddressModalOpen, setIsAddressModalOpen] = useState(false);\n  const [isWithdrawModalOpen, setIsWithdrawModalOpen] = useState(false);\n  const [isSuccessModalOpen, setIsSuccessModalOpen] = useState(false);\n  const [isResumeTransactionModalOpen, setIsResumeTransactionModalOpen] =\n    useState(false);\n  const direction = from.id === chain.id ? 'deposit' : 'withdraw';\n  const [balance, setBalance] = useState<string>('');\n  const [resumeWithdrawalTxHash, setResumeWithdrawalTxHash] = useState<Hex>();\n\n  // Deposit\n  const {\n    deposit,\n    depositStatus,\n    transactionHash: depositTransactionHash,\n    resetDepositStatus,\n  } = useDeposit();\n  const {\n    withdraw,\n    withdrawStatus,\n    waitForWithdrawal,\n    proveAndFinalizeWithdrawal,\n    finalizedWithdrawalTxHash,\n    resetWithdrawStatus,\n  } = useWithdraw({\n    config,\n    chain,\n    bridgeParams,\n  });\n\n  // Update recipient when wallet connects\n  // Defaults to current wallet address\n  useEffect(() => {\n    setBridgeParams((prev) => ({\n      ...prev,\n      recipient: address,\n    }));\n  }, [address]);\n\n  // Retrieves the ETH or ERC20 balance of the user\n  // Based on the currently selected token\n  const fetchBalance = useCallback(async () => {\n    if (!address) {\n      return;\n    }\n\n    const tokenAddress =\n      direction === 'deposit'\n        ? bridgeParams.token.address\n        : bridgeParams.token.remoteToken;\n\n    let newBalance: string;\n\n    if (\n      !tokenAddress ||\n      /* v8 ignore next 1 */\n      (direction === 'withdraw' && bridgeParams.token.isCustomGasToken)\n    ) {\n      const ethBalance = await getBalance(wagmiConfig, {\n        address,\n        chainId: from.id,\n      });\n      newBalance = formatUnits(ethBalance.value, ethBalance.decimals);\n    } else {\n      const erc20Balance = await readContract(wagmiConfig, {\n        abi: erc20Abi,\n        functionName: 'balanceOf',\n        args: [address],\n        address: tokenAddress as Address,\n        chainId: from.id,\n      });\n      newBalance = formatUnits(erc20Balance, bridgeParams.token.decimals);\n    }\n\n    setBalance(newBalance);\n  }, [address, direction, bridgeParams.token, from.id, wagmiConfig]);\n\n  // Fetch balance when bridge params change\n  useEffect(() => {\n    fetchBalance();\n  }, [fetchBalance]);\n\n  // Fetch balance when withdraw is successful\n  useEffect(() => {\n    if (\n      withdrawStatus === 'claimSuccess' ||\n      depositStatus === 'depositSuccess'\n    ) {\n      fetchBalance();\n    }\n  }, [withdrawStatus, depositStatus, fetchBalance]);\n\n  const handleToggle = useCallback(() => {\n    const tmp = from;\n    setFrom(to);\n    setTo(tmp);\n    // Reset statuses when direction changes\n    resetDepositStatus();\n    resetWithdrawStatus();\n  }, [from, to, resetDepositStatus, resetWithdrawStatus]);\n\n  const handleAmountChange = useCallback(\n    async ({\n      amount,\n      token,\n      remoteToken,\n    }: {\n      amount: string;\n      token: Token;\n      remoteToken?: Token;\n    }) => {\n      setIsPriceLoading(true);\n      setBridgeParams((prev) => ({\n        ...prev,\n        amount,\n        token,\n        remoteToken,\n      }));\n\n      const amountUSD = await handleFetchPrice(amount, token);\n\n      setBridgeParams((prev) => ({\n        ...prev,\n        amountUSD,\n      }));\n      setIsPriceLoading(false);\n    },\n    [handleFetchPrice],\n  );\n\n  const handleAddressSelect = useCallback((address: Address) => {\n    setBridgeParams((prev) => ({\n      ...prev,\n      recipient: address,\n    }));\n  }, []);\n\n  const handleResumeTransaction = useCallback((txHash: Hex) => {\n    setResumeWithdrawalTxHash(txHash);\n    setIsResumeTransactionModalOpen(false);\n  }, []);\n\n  const handleOpenExplorer = useCallback(() => {\n    const blockExplorerUrl = getChainExplorer(chain.id);\n    const txHash =\n      depositStatus === 'depositSuccess'\n        ? depositTransactionHash\n        : finalizedWithdrawalTxHash;\n    window.open(`${blockExplorerUrl}/tx/${txHash}`, '_blank');\n  }, [\n    chain.id,\n    depositStatus,\n    depositTransactionHash,\n    finalizedWithdrawalTxHash,\n  ]);\n\n  const handleDeposit = useCallback(async () => {\n    await deposit({\n      config,\n      from,\n      bridgeParams,\n    });\n  }, [deposit, config, from, bridgeParams]);\n\n  const handleWithdraw = useCallback(async () => {\n    await withdraw();\n  }, [withdraw]);\n\n  const handleResetState = useCallback(() => {\n    setIsSuccessModalOpen(false);\n    setIsWithdrawModalOpen(false);\n    setIsResumeTransactionModalOpen(false);\n\n    setResumeWithdrawalTxHash(undefined);\n  }, []);\n\n  // Open withdraw modal when withdraw is successful, or when transaction is resumed\n  useEffect(() => {\n    if (withdrawStatus === 'withdrawSuccess' || resumeWithdrawalTxHash) {\n      setIsWithdrawModalOpen(true);\n    }\n  }, [withdrawStatus, resumeWithdrawalTxHash]);\n\n  // Reset withdraw status when withdraw modal is closed\n  useEffect(() => {\n    if (!isWithdrawModalOpen) {\n      resetWithdrawStatus();\n    }\n  }, [isWithdrawModalOpen, resetWithdrawStatus]);\n\n  // Open success modal when deposit is successful\n  useEffect(() => {\n    if (depositStatus === 'depositSuccess') {\n      setIsSuccessModalOpen(true);\n    }\n  }, [depositStatus]);\n\n  // Open success modal when withdraw is successful\n  useEffect(() => {\n    if (withdrawStatus === 'claimSuccess') {\n      setIsSuccessModalOpen(true);\n    }\n  }, [withdrawStatus]);\n\n  const value = useValue({\n    // Internal\n    config,\n    from,\n    to,\n    bridgeableTokens,\n    bridgeParams,\n    isPriceLoading,\n\n    // Bridge UI\n    balance,\n    handleToggle,\n    handleAmountChange,\n\n    // Address modal\n    isAddressModalOpen,\n    setIsAddressModalOpen,\n    handleAddressSelect,\n\n    // Success modal\n    isSuccessModalOpen,\n    setIsSuccessModalOpen,\n    handleOpenExplorer,\n    handleResetState,\n\n    // Resume transaction modal\n    isResumeTransactionModalOpen,\n    setIsResumeTransactionModalOpen,\n    resumeWithdrawalTxHash,\n    setResumeWithdrawalTxHash,\n    handleResumeTransaction,\n\n    // Deposits and Withdrawals\n    handleDeposit,\n    depositStatus,\n    depositTransactionHash,\n    direction,\n    handleWithdraw,\n    withdrawStatus,\n    waitForWithdrawal,\n    proveAndFinalizeWithdrawal,\n    finalizedWithdrawalTxHash,\n    isWithdrawModalOpen,\n    setIsWithdrawModalOpen,\n    resetDepositStatus,\n    resetWithdrawStatus,\n  });\n\n  return (\n    <AppchainBridgeContext.Provider value={value}>\n      {children}\n    </AppchainBridgeContext.Provider>\n  );\n};\n\nexport const useAppchainBridgeContext = () => {\n  const context = useContext(AppchainBridgeContext);\n  if (context === undefined) {\n    throw new Error('useAppchainBridge must be used within a BridgeProvider');\n  }\n  return context;\n};\n"],"names":["AppchainBridgeContext","createContext","undefined","AppchainBridgeProvider","children","chain","appchain","bridgeableTokens","DEFAULT_BRIDGEABLE_TOKENS","handleFetchPrice","defaultPriceFetcher","from","setFrom","useState","icon","baseSvg","to","setTo","coinbaseLogoSvg","config","error","useChainConfig","l2ChainId","id","appchainChainId","console","Error","length","address","useAccount","wagmiConfig","useConfig","bridgeParams","setBridgeParams","amount","amountUSD","token","recipient","isPriceLoading","setIsPriceLoading","isAddressModalOpen","setIsAddressModalOpen","isWithdrawModalOpen","setIsWithdrawModalOpen","isSuccessModalOpen","setIsSuccessModalOpen","isResumeTransactionModalOpen","setIsResumeTransactionModalOpen","direction","balance","setBalance","resumeWithdrawalTxHash","setResumeWithdrawalTxHash","deposit","depositStatus","transactionHash","depositTransactionHash","resetDepositStatus","useDeposit","withdraw","withdrawStatus","waitForWithdrawal","proveAndFinalizeWithdrawal","finalizedWithdrawalTxHash","resetWithdrawStatus","useWithdraw","useEffect","prev","fetchBalance","useCallback","tokenAddress","remoteToken","newBalance","isCustomGasToken","ethBalance","getBalance","chainId","formatUnits","value","decimals","erc20Balance","readContract","abi","erc20Abi","functionName","args","handleToggle","tmp","handleAmountChange","handleAddressSelect","handleResumeTransaction","txHash","handleOpenExplorer","blockExplorerUrl","getChainExplorer","window","open","handleDeposit","handleWithdraw","handleResetState","useValue","useAppchainBridgeContext","context","useContext"],"mappings":"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"}