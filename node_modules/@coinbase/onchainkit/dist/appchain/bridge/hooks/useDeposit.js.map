{"version":3,"file":"useDeposit.js","sources":["../../../../src/appchain/bridge/hooks/useDeposit.ts"],"sourcesContent":["'use client';\nimport { useAnalytics } from '@/core/analytics/hooks/useAnalytics';\nimport { AppchainEvent } from '@/core/analytics/types';\nimport { useCallback, useState } from 'react';\nimport { parseEther, parseUnits } from 'viem';\nimport type { Hex } from 'viem';\nimport { useAccount, useConfig, useSwitchChain, useWriteContract } from 'wagmi';\nimport { waitForTransactionReceipt } from 'wagmi/actions';\nimport { ERC20ABI, OptimismPortalABI, StandardBridgeABI } from '../abi';\nimport { EXTRA_DATA, MIN_GAS_LIMIT } from '../constants';\nimport type { UseDepositParams } from '../types';\nimport { isUserRejectedRequestError } from '../utils/isUserRejectedRequestError';\n\nexport function useDeposit() {\n  const { writeContractAsync, data } = useWriteContract();\n  const { switchChainAsync } = useSwitchChain();\n  const { chainId } = useAccount();\n  const wagmiConfig = useConfig();\n  const [status, setStatus] = useState<\n    'depositPending' | 'depositSuccess' | 'error' | 'idle' | 'depositRejected'\n  >('idle');\n  const { sendAnalytics } = useAnalytics();\n\n  const resetDepositStatus = useCallback(() => {\n    setStatus('idle');\n  }, []);\n\n  const deposit = async ({ config, from, bridgeParams }: UseDepositParams) => {\n    if (!bridgeParams.recipient) {\n      throw new Error('Recipient is required');\n    }\n\n    if (chainId !== from.id) {\n      await switchChainAsync({ chainId: from.id });\n    }\n\n    sendAnalytics(AppchainEvent.AppchainBridgeDepositInitiated, {\n      amount: bridgeParams.amount,\n      tokenAddress: bridgeParams.token.address,\n      recipient: bridgeParams.recipient,\n    });\n\n    setStatus('depositPending');\n\n    try {\n      // Native ETH\n      if (bridgeParams.token.address === '') {\n        const txHash = await writeContractAsync({\n          abi: StandardBridgeABI,\n          functionName: 'bridgeETHTo',\n          args: [bridgeParams.recipient, MIN_GAS_LIMIT, EXTRA_DATA],\n          address: config.contracts.l1StandardBridge,\n          value: parseEther(bridgeParams.amount),\n          chainId: from.id,\n        });\n\n        await waitForTransactionReceipt(wagmiConfig, {\n          hash: txHash,\n          confirmations: 1,\n          chainId: from.id,\n        });\n      } else {\n        // ERC20\n        if (!bridgeParams.token.remoteToken) {\n          throw new Error('Remote token address is required for ERC-20 tokens');\n        }\n\n        const formattedAmount = parseUnits(\n          bridgeParams.amount,\n          bridgeParams.token.decimals,\n        );\n\n        // Bridge address is OptimismPortal for depositing custom gas tokens\n        const bridgeAddress = bridgeParams.token.isCustomGasToken\n          ? config.contracts.optimismPortal\n          : config.contracts.l1StandardBridge;\n\n        // Approve the L1StandardBridge to spend tokens\n        const approveTx = await writeContractAsync({\n          abi: ERC20ABI,\n          functionName: 'approve',\n          args: [bridgeAddress, formattedAmount],\n          address: bridgeParams.token.address,\n        });\n        await waitForTransactionReceipt(wagmiConfig, {\n          hash: approveTx,\n          confirmations: 1,\n          chainId: from.id,\n        });\n\n        let bridgeTxHash: Hex;\n\n        // Bridge the tokens\n        if (bridgeParams.token.isCustomGasToken) {\n          bridgeTxHash = await writeContractAsync({\n            abi: OptimismPortalABI,\n            functionName: 'depositERC20Transaction',\n            args: [\n              bridgeParams.recipient,\n              formattedAmount,\n              formattedAmount,\n              BigInt(MIN_GAS_LIMIT),\n              false,\n              EXTRA_DATA,\n            ],\n            address: bridgeAddress,\n          });\n        } else {\n          bridgeTxHash = await writeContractAsync({\n            abi: StandardBridgeABI,\n            functionName: 'bridgeERC20To',\n            args: [\n              bridgeParams.token.address,\n              bridgeParams.token.remoteToken, // TODO: manually calculate the salted address\n              bridgeParams.recipient,\n              formattedAmount,\n              MIN_GAS_LIMIT,\n              EXTRA_DATA,\n            ],\n            address: bridgeAddress,\n          });\n        }\n\n        await waitForTransactionReceipt(wagmiConfig, {\n          hash: bridgeTxHash,\n          confirmations: 1,\n          chainId: from.id,\n        });\n      }\n\n      sendAnalytics(AppchainEvent.AppchainBridgeDepositSuccess, {\n        amount: bridgeParams.amount,\n        tokenAddress: bridgeParams.token.address,\n        recipient: bridgeParams.recipient,\n      });\n\n      setStatus('depositSuccess');\n    } catch (error) {\n      if (isUserRejectedRequestError(error)) {\n        console.error('User rejected request');\n        setStatus('depositRejected');\n      } else {\n        setStatus('error');\n        sendAnalytics(AppchainEvent.AppchainBridgeDepositFailure, {\n          error: error instanceof Error ? error.message : 'Unknown error',\n        });\n      }\n    }\n  };\n\n  return {\n    deposit,\n    depositStatus: status,\n    transactionHash: data,\n    resetDepositStatus,\n  };\n}\n"],"names":["useDeposit","writeContractAsync","data","useWriteContract","switchChainAsync","useSwitchChain","chainId","useAccount","wagmiConfig","useConfig","status","setStatus","useState","sendAnalytics","useAnalytics","resetDepositStatus","useCallback","deposit","config","from","bridgeParams","recipient","Error","id","AppchainEvent","AppchainBridgeDepositInitiated","amount","tokenAddress","token","address","txHash","abi","StandardBridgeABI","functionName","args","MIN_GAS_LIMIT","EXTRA_DATA","contracts","l1StandardBridge","value","parseEther","waitForTransactionReceipt","hash","confirmations","remoteToken","formattedAmount","parseUnits","decimals","bridgeAddress","isCustomGasToken","optimismPortal","approveTx","ERC20ABI","bridgeTxHash","OptimismPortalABI","BigInt","AppchainBridgeDepositSuccess","error","isUserRejectedRequestError","console","AppchainBridgeDepositFailure","message","depositStatus","transactionHash"],"mappings":"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"}