'use client';
import { jsxs, jsx } from "react/jsx-runtime";
import { useAnalytics } from "../../core/analytics/hooks/useAnalytics.js";
import { BuyEvent } from "../../core/analytics/types.js";
import { openPopup } from "../../internal/utils/openPopup.js";
import { useCallback, useMemo, useEffect } from "react";
import { getFundingPopupSize } from "../../fund/utils/getFundingPopupSize.js";
import { getRoundedAmount } from "../../internal/utils/getRoundedAmount.js";
import { cn, text } from "../../styles/theme.js";
import { ONRAMP_PAYMENT_METHODS } from "../constants.js";
import { getBuyFundingUrl } from "../utils/getBuyFundingUrl.js";
import { isApplePaySupported } from "../utils/isApplePaySupported.js";
import { BuyOnrampItem } from "./BuyOnrampItem.js";
import { useBuyContext } from "./BuyProvider.js";
import { BuyTokenItem } from "./BuyTokenItem.js";
function BuyDropdown() {
  var _a, _b, _c, _d, _e, _f, _g;
  const {
    to,
    fromETH,
    fromUSDC,
    from,
    startPopupMonitor,
    setIsDropdownOpen,
    sessionToken
  } = useBuyContext();
  const {
    sendAnalytics
  } = useAnalytics();
  const handleOnrampClick = useCallback((paymentMethodId) => {
    return () => {
      sendAnalytics(BuyEvent.BuyOptionSelected, {
        option: paymentMethodId
      });
      const fundingUrl = getBuyFundingUrl({
        to,
        paymentMethodId,
        sessionToken
      });
      if (!fundingUrl) {
        return;
      }
      const {
        height,
        width
      } = getFundingPopupSize("md", fundingUrl);
      const popupWindow = openPopup({
        url: fundingUrl,
        height,
        width,
        target: "_blank"
      });
      if (popupWindow) {
        startPopupMonitor(popupWindow);
      }
    };
  }, [sendAnalytics, to, sessionToken, startPopupMonitor]);
  const formattedAmountUSD = useMemo(() => {
    if (!(to == null ? void 0 : to.amountUSD) || (to == null ? void 0 : to.amountUSD) === "0") {
      return null;
    }
    const roundedAmount = Number(getRoundedAmount(to == null ? void 0 : to.amountUSD, 2));
    return `$${roundedAmount.toFixed(2)}`;
  }, [to == null ? void 0 : to.amountUSD]);
  const isToETH = ((_a = to == null ? void 0 : to.token) == null ? void 0 : _a.symbol) === "ETH";
  const isToUSDC = ((_b = to == null ? void 0 : to.token) == null ? void 0 : _b.symbol) === "USDC";
  const showFromToken = ((_c = to == null ? void 0 : to.token) == null ? void 0 : _c.symbol) !== ((_d = from == null ? void 0 : from.token) == null ? void 0 : _d.symbol) && from && ((_e = from == null ? void 0 : from.token) == null ? void 0 : _e.symbol) !== "ETH" && ((_f = from == null ? void 0 : from.token) == null ? void 0 : _f.symbol) !== "USDC";
  useEffect(() => {
    const handleKeyDown = (event) => {
      if (event.key === "Escape") {
        setIsDropdownOpen(false);
      }
    };
    document.addEventListener("keydown", handleKeyDown);
    return () => {
      document.removeEventListener("keydown", handleKeyDown);
    };
  }, [setIsDropdownOpen]);
  const isApplePayEnabled = isApplePaySupported();
  const availablePaymentMethods = useMemo(() => {
    return ONRAMP_PAYMENT_METHODS.filter((method) => {
      if (method.id === "APPLE_PAY") {
        return isApplePayEnabled;
      }
      return true;
    });
  }, [isApplePayEnabled]);
  return /* @__PURE__ */ jsxs("div", { className: cn("ock:text-ock-foreground", "ock:bg-ock-background", "ock:absolute ock:right-0 ock:bottom-0 ock:flex ock:translate-y-[102%] ock:flex-col ock:gap-2", "ock:z-10 ock:min-w-80 ock:rounded ock:border ock:p-2", "ock:rounded-ock-default"), role: "menu", "aria-label": "Buy options", children: [
    /* @__PURE__ */ jsx("div", { className: cn(text.headline, "ock:px-2 ock:pt-2"), role: "heading", "aria-level": 2, children: "Buy with" }),
    !isToETH && /* @__PURE__ */ jsx(BuyTokenItem, { swapUnit: fromETH }),
    !isToUSDC && /* @__PURE__ */ jsx(BuyTokenItem, { swapUnit: fromUSDC }),
    showFromToken && /* @__PURE__ */ jsx(BuyTokenItem, { swapUnit: from }),
    availablePaymentMethods.map((method) => {
      return /* @__PURE__ */ jsx(BuyOnrampItem, { name: method.name, description: method.description, onClick: handleOnrampClick(method.id), icon: method.icon, to }, method.id);
    }),
    !!formattedAmountUSD && /* @__PURE__ */ jsx("div", { className: cn("ock:flex ock:justify-end", text.legal, "ock:text-ock-foreground-muted"), children: `${to == null ? void 0 : to.amount} ${(_g = to == null ? void 0 : to.token) == null ? void 0 : _g.name} â‰ˆ ${formattedAmountUSD}` })
  ] });
}
export {
  BuyDropdown
};
//# sourceMappingURL=BuyDropdown.js.map
