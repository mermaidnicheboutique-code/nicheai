{"version":3,"file":"request.js","sources":["../../../src/core/network/request.ts"],"sourcesContent":["import { clientMetaManager } from '../clientMeta/clientMetaManager';\nimport {\n  CONTEXT_HEADER,\n  JSON_HEADERS,\n  JSON_RPC_VERSION,\n  POST_METHOD,\n  RequestContext,\n  RequestContextType,\n} from './constants';\nimport { getRPCUrl } from './getRPCUrl';\n\nexport type JSONRPCError = {\n  code: number;\n  message: string;\n};\n\nexport type JSONRPCRequest<T> = {\n  id: number;\n  jsonrpc: string;\n  method: string;\n  params: T[];\n};\n\nexport type JSONRPCResult<T> = {\n  error?: JSONRPCError;\n  id: number;\n  jsonrpc: string;\n  result: T;\n};\n\n/**\n * Builds a JSON-RPC request body.\n *\n * @param method - The method name.\n * @param params - The parameters for the method.\n * @returns The JSON-RPC request body.\n * @template T - The type of the parameters.\n */\nexport function buildRequestBody<T>(\n  method: string,\n  params: T[],\n): JSONRPCRequest<T> {\n  return {\n    id: 1,\n    jsonrpc: JSON_RPC_VERSION,\n    method: method,\n    params: params,\n  };\n}\n\n/**\n * Builds the headers for a JSON-RPC request.\n *\n * @params context - Tracks the context where the request originated\n * @returns The headers for the JSON-RPC request.\n */\nasync function buildRequestHeaders(\n  context?: RequestContextType,\n): Promise<Record<string, string>> {\n  const headers: Record<string, string> = {\n    ...JSON_HEADERS,\n  };\n\n  const clientMeta = await clientMetaManager.getClientMeta().catch(() => null);\n\n  if (clientMeta) {\n    headers['OnchainKit-Client-Fid'] = clientMeta.clientFid?.toString() ?? '';\n    headers['OnchainKit-Mode'] = clientMeta.mode;\n  }\n\n  if (context) {\n    // if an invalid context is provided, default to 'api'\n    if (!Object.values(RequestContext).includes(context)) {\n      return {\n        ...headers,\n        [CONTEXT_HEADER]: RequestContext.API,\n      };\n    }\n\n    return {\n      ...headers,\n      [CONTEXT_HEADER]: context,\n    };\n  }\n  return headers;\n}\n\n/**\n * Sends a JSON-RPC request to configured RPC URL.\n * Defaults to using the Coinbase Developer Platform Node.\n *\n * @param method - The method name.\n * @param params - The parameters for the method.\n * @returns A promise that resolves to the JSON-RPC response.\n * @throws If an error occurs while sending the request.\n */\nexport async function sendRequest<T, V>(\n  method: string,\n  params: T[],\n  _context?: RequestContextType,\n): Promise<JSONRPCResult<V>> {\n  try {\n    const body = buildRequestBody<T>(method, params);\n    const url = getRPCUrl();\n    const response = await fetch(url, {\n      body: JSON.stringify(body),\n      headers: await buildRequestHeaders(_context),\n      method: POST_METHOD,\n    });\n    const data: JSONRPCResult<V> = await response.json();\n    return data;\n  } catch (error) {\n    console.log(\n      `sendRequest: error sending request: ${(error as Error).message}`,\n    );\n    throw error;\n  }\n}\n"],"names":["buildRequestBody","method","params","id","jsonrpc","JSON_RPC_VERSION","buildRequestHeaders","context","headers","JSON_HEADERS","clientMeta","clientMetaManager","getClientMeta","catch","clientFid","toString","mode","Object","values","RequestContext","includes","CONTEXT_HEADER","API","sendRequest","_context","body","url","getRPCUrl","response","fetch","JSON","stringify","POST_METHOD","data","json","error","console","log","message"],"mappings":";;;AAsCgBA,SAAAA,iBACdC,QACAC,QACmB;AACZ,SAAA;AAAA,IACLC,IAAI;AAAA,IACJC,SAASC;AAAAA,IACTJ;AAAAA,IACAC;AAAAA,EACF;AACF;AAQA,eAAeI,oBACbC,SACiC;;AACjC,QAAMC,UAAkC;AAAA,IACtC,GAAGC;AAAAA,EACL;AAEA,QAAMC,aAAa,MAAMC,kBAAkBC,gBAAgBC,MAAM,MAAM,IAAI;AAE3E,MAAIH,YAAY;AACdF,YAAQ,uBAAuB,MAAIE,gBAAWI,cAAXJ,mBAAsBK,eAAc;AAC/D,YAAA,iBAAiB,IAAIL,WAAWM;AAAAA,EAAAA;AAG1C,MAAIT,SAAS;AAEX,QAAI,CAACU,OAAOC,OAAOC,cAAc,EAAEC,SAASb,OAAO,GAAG;AAC7C,aAAA;AAAA,QACL,GAAGC;AAAAA,QACH,CAACa,cAAc,GAAGF,eAAeG;AAAAA,MACnC;AAAA,IAAA;AAGK,WAAA;AAAA,MACL,GAAGd;AAAAA,MACH,CAACa,cAAc,GAAGd;AAAAA,IACpB;AAAA,EAAA;AAEKC,SAAAA;AACT;AAWsBe,eAAAA,YACpBtB,QACAC,QACAsB,UAC2B;AACvB,MAAA;AACIC,UAAAA,OAAOzB,iBAAoBC,QAAQC,MAAM;AAC/C,UAAMwB,MAAMC,UAAU;AAChBC,UAAAA,WAAW,MAAMC,MAAMH,KAAK;AAAA,MAChCD,MAAMK,KAAKC,UAAUN,IAAI;AAAA,MACzBjB,SAAS,MAAMF,oBAAoBkB,QAAQ;AAAA,MAC3CvB,QAAQ+B;AAAAA,IAAAA,CACT;AACKC,UAAAA,OAAyB,MAAML,SAASM,KAAK;AAC5CD,WAAAA;AAAAA,WACAE,OAAO;AACdC,YAAQC,IACN,uCAAwCF,MAAgBG,OAAO,EACjE;AACMH,UAAAA;AAAAA,EAAAA;AAEV;"}