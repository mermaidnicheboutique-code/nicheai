{"version":3,"file":"processSwapTransaction.js","sources":["../../../src/swap/utils/processSwapTransaction.ts"],"sourcesContent":["import type { Address } from 'viem';\nimport { encodeFunctionData, parseAbi } from 'viem';\nimport { base } from 'viem/chains';\nimport {\n  PERMIT2_CONTRACT_ADDRESS,\n  UNIVERSALROUTER_CONTRACT_ADDRESS,\n} from '../constants';\nimport type { ProcessSwapTransactionParams, SwapTransaction } from '../types';\nimport { sendSwapTransactions } from './sendSwapTransactions';\n\nexport async function processSwapTransaction({\n  chainId,\n  config,\n  isSponsored,\n  paymaster,\n  sendCallsAsync,\n  sendTransactionAsync,\n  swapTransaction,\n  switchChainAsync,\n  updateLifecycleStatus,\n  useAggregator,\n  walletCapabilities,\n}: ProcessSwapTransactionParams) {\n  const { transaction, approveTransaction, quote } = swapTransaction;\n  const transactions: SwapTransaction[] = [];\n\n  // for swaps from ERC-20 tokens,\n  // if there is an approveTransaction present,\n  // request approval for the amount\n  // for V1 API, `approveTx` will be an ERC-20 approval against the Router\n  // for V2 API, `approveTx` will be an ERC-20 approval against the `Permit2` contract\n  if (approveTransaction?.data) {\n    transactions.push({\n      transaction: {\n        to: approveTransaction.to,\n        value: approveTransaction.value,\n        data: approveTransaction.data,\n      },\n      transactionType: 'ERC20',\n    });\n\n    // for the V2 API, we use Uniswap's `UniversalRouter`, which uses `Permit2` for ERC-20 approvals\n    // this adds an additional transaction/step to the swap process\n    // since we need to make an extra transaction to `Permit2` to allow the UniversalRouter to spend the approved funds\n    // this would typically be a (gasless) signature, but we're using a transaction here to allow batching for Smart Wallets\n    // read more: https://blog.uniswap.org/permit2-and-universal-router\n    if (!useAggregator) {\n      const permit2ContractAbi = parseAbi([\n        'function approve(address token, address spender, uint160 amount, uint48 expiration) external',\n      ]);\n      const data = encodeFunctionData({\n        abi: permit2ContractAbi,\n        functionName: 'approve',\n        args: [\n          quote.from.address as Address,\n          UNIVERSALROUTER_CONTRACT_ADDRESS,\n          BigInt(quote.fromAmount),\n          20_000_000_000_000, // The deadline where the approval is no longer valid - see https://docs.uniswap.org/contracts/permit2/reference/allowance-transfer\n        ],\n      });\n      transactions.push({\n        transaction: {\n          to: PERMIT2_CONTRACT_ADDRESS,\n          value: 0n,\n          data,\n        },\n        transactionType: 'Permit2',\n      });\n    }\n  }\n  // The Swap Execution Transaction\n  transactions.push({\n    transaction: {\n      to: transaction.to,\n      value: transaction.value,\n      data: transaction.data,\n    },\n    transactionType: 'Swap',\n  });\n\n  // Switch to Base if the wallet is not on the current chain\n  if (chainId !== base.id) {\n    await switchChainAsync({ chainId: base.id });\n  }\n\n  await sendSwapTransactions({\n    config,\n    isSponsored,\n    paymaster,\n    sendCallsAsync,\n    sendTransactionAsync,\n    transactions,\n    updateLifecycleStatus,\n    walletCapabilities,\n  });\n}\n"],"names":["processSwapTransaction","chainId","config","isSponsored","paymaster","sendCallsAsync","sendTransactionAsync","swapTransaction","switchChainAsync","updateLifecycleStatus","useAggregator","walletCapabilities","transaction","approveTransaction","quote","transactions","data","push","to","value","transactionType","permit2ContractAbi","parseAbi","encodeFunctionData","abi","functionName","args","from","address","UNIVERSALROUTER_CONTRACT_ADDRESS","BigInt","fromAmount","PERMIT2_CONTRACT_ADDRESS","base","id","sendSwapTransactions"],"mappings":";;;;AAUA,eAAsBA,uBAAuB;AAAA,EAC3CC;AAAAA,EACAC;AAAAA,EACAC;AAAAA,EACAC;AAAAA,EACAC;AAAAA,EACAC;AAAAA,EACAC;AAAAA,EACAC;AAAAA,EACAC;AAAAA,EACAC;AAAAA,EACAC;AAC4B,GAAG;AACzB,QAAA;AAAA,IAAEC;AAAAA,IAAaC;AAAAA,IAAoBC;AAAAA,EAAAA,IAAUP;AACnD,QAAMQ,eAAkC,CAAE;AAO1C,MAAIF,yDAAoBG,MAAM;AAC5BD,iBAAaE,KAAK;AAAA,MAChBL,aAAa;AAAA,QACXM,IAAIL,mBAAmBK;AAAAA,QACvBC,OAAON,mBAAmBM;AAAAA,QAC1BH,MAAMH,mBAAmBG;AAAAA,MAC3B;AAAA,MACAI,iBAAiB;AAAA,IAAA,CAClB;AAOD,QAAI,CAACV,eAAe;AAClB,YAAMW,qBAAqBC,SAAS,CAClC,8FAA8F,CAC/F;AACD,YAAMN,OAAOO,mBAAmB;AAAA,QAC9BC,KAAKH;AAAAA,QACLI,cAAc;AAAA,QACdC,MAAM;AAAA,UACJZ,MAAMa,KAAKC;AAAAA,UACXC;AAAAA,UACAC,OAAOhB,MAAMiB,UAAU;AAAA,UACvB;AAAA;AAAA,QAAA;AAAA,MAAoB,CAEvB;AACDhB,mBAAaE,KAAK;AAAA,QAChBL,aAAa;AAAA,UACXM,IAAIc;AAAAA,UACJb,OAAO;AAAA,UACPH;AAAAA,QACF;AAAA,QACAI,iBAAiB;AAAA,MAAA,CAClB;AAAA,IAAA;AAAA,EACH;AAGFL,eAAaE,KAAK;AAAA,IAChBL,aAAa;AAAA,MACXM,IAAIN,YAAYM;AAAAA,MAChBC,OAAOP,YAAYO;AAAAA,MACnBH,MAAMJ,YAAYI;AAAAA,IACpB;AAAA,IACAI,iBAAiB;AAAA,EAAA,CAClB;AAGGnB,MAAAA,YAAYgC,KAAKC,IAAI;AACvB,UAAM1B,iBAAiB;AAAA,MAAEP,SAASgC,KAAKC;AAAAA,IAAAA,CAAI;AAAA,EAAA;AAG7C,QAAMC,qBAAqB;AAAA,IACzBjC;AAAAA,IACAC;AAAAA,IACAC;AAAAA,IACAC;AAAAA,IACAC;AAAAA,IACAS;AAAAA,IACAN;AAAAA,IACAE;AAAAA,EAAAA,CACD;AACH;"}