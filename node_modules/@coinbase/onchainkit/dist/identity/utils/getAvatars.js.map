{"version":3,"file":"getAvatars.js","sources":["../../../src/identity/utils/getAvatars.ts"],"sourcesContent":["import { getChainPublicClient } from '@/core/network/getChainPublicClient';\nimport { isBase } from '@/core/utils/isBase';\nimport { isEthereum } from '@/core/utils/isEthereum';\nimport type {\n  Basename,\n  GetAvatarReturnType,\n  GetAvatarsParams,\n} from '@/identity/types';\nimport { mainnet } from 'viem/chains';\nimport { normalize } from 'viem/ens';\nimport { RESOLVER_ADDRESSES_BY_CHAIN_ID } from '../constants';\nimport { getBaseDefaultProfilePicture } from './getBaseDefaultProfilePicture';\nimport { isBasename } from './isBasename';\n\n/**\n * An asynchronous function to fetch multiple Basenames or Ethereum Name Service (ENS)\n * avatars for a given array of ENS names in a single batch request.\n * It returns an array of avatar URLs in the same order as the input names.\n */\nexport const getAvatars = async ({\n  ensNames,\n  chain = mainnet,\n}: GetAvatarsParams): Promise<GetAvatarReturnType[]> => {\n  if (!ensNames || ensNames.length === 0) {\n    return [];\n  }\n\n  const chainIsBase = isBase({ chainId: chain.id });\n  const chainIsEthereum = isEthereum({ chainId: chain.id });\n  const chainSupportsUniversalResolver = chainIsEthereum || chainIsBase;\n\n  if (!chainSupportsUniversalResolver) {\n    return Promise.reject(\n      'ChainId not supported, avatar resolution is only supported on Ethereum and Base.',\n    );\n  }\n\n  const results: GetAvatarReturnType[] = Array(ensNames.length).fill(null);\n\n  // Categorize names by type for optimized processing\n  const basenameIndices: number[] = [];\n  const normalIndices: number[] = [];\n\n  ensNames.forEach((name, index) => {\n    if (isBasename(name)) {\n      basenameIndices.push(index);\n    } else {\n      normalIndices.push(index);\n    }\n  });\n\n  // Process Base avatars\n  if (chainIsBase && basenameIndices.length > 0) {\n    const client = getChainPublicClient(chain);\n\n    try {\n      // Create batch of calls for Base avatars with individual error handling\n      const baseAvatarPromises = basenameIndices.map((index) =>\n        client\n          .getEnsAvatar({\n            name: normalize(ensNames[index]),\n            universalResolverAddress: RESOLVER_ADDRESSES_BY_CHAIN_ID[chain.id],\n          })\n          .catch((error) => {\n            console.error(\n              `Error resolving Base avatar for ${ensNames[index]}:`,\n              error,\n            );\n            return null; // Return null for failed resolutions\n          }),\n      );\n\n      const baseAvatarResults = await Promise.all(baseAvatarPromises);\n\n      baseAvatarResults.forEach((avatar, i) => {\n        const originalIndex = basenameIndices[i];\n        if (avatar) {\n          results[originalIndex] = avatar;\n        }\n      });\n    } catch (error) {\n      console.error('Error resolving Base avatars in batch:', error);\n    }\n  }\n\n  // Process mainnet avatars\n  const fallbackClient = getChainPublicClient(mainnet);\n\n  try {\n    // Create batch of ENS avatar resolution calls with individual error handling\n    const ensAvatarPromises = ensNames.map((name, index) => {\n      // Skip if we already have a result\n      if (results[index] !== null) {\n        return Promise.resolve(null);\n      }\n      return fallbackClient\n        .getEnsAvatar({\n          name: normalize(name),\n        })\n        .catch((error) => {\n          console.error(`Error resolving ENS avatar for ${name}:`, error);\n          return null; // Return null for failed resolutions\n        });\n    });\n\n    // Execute all ENS avatar resolution calls\n    const ensAvatarResults = await Promise.all(ensAvatarPromises);\n\n    // Update results with ENS avatars\n    ensAvatarResults.forEach((avatar, index) => {\n      if (avatar && results[index] === null) {\n        results[index] = avatar;\n      }\n    });\n  } catch (error) {\n    console.error('Error resolving ENS avatars in batch:', error);\n  }\n\n  // Apply default Base profile pictures for basenames that don't have avatars\n  for (const index of basenameIndices) {\n    if (results[index] === null) {\n      results[index] = getBaseDefaultProfilePicture(\n        ensNames[index] as Basename,\n      );\n    }\n  }\n\n  return results;\n};\n"],"names":["getAvatars","ensNames","chain","mainnet","length","chainIsBase","isBase","chainId","id","chainIsEthereum","isEthereum","chainSupportsUniversalResolver","Promise","reject","results","Array","fill","basenameIndices","forEach","name","index","isBasename","push","client","getChainPublicClient","baseAvatarPromises","map","getEnsAvatar","normalize","universalResolverAddress","RESOLVER_ADDRESSES_BY_CHAIN_ID","catch","error","console","baseAvatarResults","all","avatar","i","originalIndex","fallbackClient","ensAvatarPromises","resolve","ensAvatarResults","getBaseDefaultProfilePicture"],"mappings":";;;;;;;;AAmBO,MAAMA,aAAa,OAAO;AAAA,EAC/BC;AAAAA,EACAC,QAAQC;AACQ,MAAsC;AACtD,MAAI,CAACF,YAAYA,SAASG,WAAW,GAAG;AACtC,WAAO,CAAE;AAAA,EAAA;AAGX,QAAMC,cAAcC,OAAO;AAAA,IAAEC,SAASL,MAAMM;AAAAA,EAAAA,CAAI;AAChD,QAAMC,kBAAkBC,WAAW;AAAA,IAAEH,SAASL,MAAMM;AAAAA,EAAAA,CAAI;AACxD,QAAMG,iCAAiCF,mBAAmBJ;AAE1D,MAAI,CAACM,gCAAgC;AAC5BC,WAAAA,QAAQC,OACb,kFACF;AAAA,EAAA;AAGF,QAAMC,UAAiCC,MAAMd,SAASG,MAAM,EAAEY,KAAK,IAAI;AAGvE,QAAMC,kBAA4B,CAAE;AAG3BC,WAAAA,QAAQ,CAACC,MAAMC,UAAU;AAC5BC,QAAAA,WAAWF,IAAI,GAAG;AACpBF,sBAAgBK,KAAKF,KAAK;AAAA,IAAA;AAAA,EAG5B,CACD;AAGGf,MAAAA,eAAeY,gBAAgBb,SAAS,GAAG;AACvCmB,UAAAA,SAASC,qBAAqBtB,KAAK;AAErC,QAAA;AAEF,YAAMuB,qBAAqBR,gBAAgBS,IAAKN,CAAAA,UAC9CG,OACGI,aAAa;AAAA,QACZR,MAAMS,UAAU3B,SAASmB,KAAK,CAAC;AAAA,QAC/BS,0BAA0BC,+BAA+B5B,MAAMM,EAAE;AAAA,MAAA,CAClE,EACAuB,MAAOC,CAAU,UAAA;AAChBC,gBAAQD,MACN,mCAAmC/B,SAASmB,KAAK,CAAC,KAClDY,KACF;AACO,eAAA;AAAA,MAAA,CACR,CACL;AAEA,YAAME,oBAAoB,MAAMtB,QAAQuB,IAAIV,kBAAkB;AAE5CP,wBAAAA,QAAQ,CAACkB,QAAQC,MAAM;AACjCC,cAAAA,gBAAgBrB,gBAAgBoB,CAAC;AACvC,YAAID,QAAQ;AACVtB,kBAAQwB,aAAa,IAAIF;AAAAA,QAAAA;AAAAA,MAC3B,CACD;AAAA,aACMJ,OAAO;AACNA,cAAAA,MAAM,0CAA0CA,KAAK;AAAA,IAAA;AAAA,EAC/D;AAIIO,QAAAA,iBAAiBf,qBAAqBrB,OAAO;AAE/C,MAAA;AAEF,UAAMqC,oBAAoBvC,SAASyB,IAAI,CAACP,MAAMC,UAAU;AAElDN,UAAAA,QAAQM,KAAK,MAAM,MAAM;AACpBR,eAAAA,QAAQ6B,QAAQ,IAAI;AAAA,MAAA;AAE7B,aAAOF,eACJZ,aAAa;AAAA,QACZR,MAAMS,UAAUT,IAAI;AAAA,MAAA,CACrB,EACAY,MAAOC,CAAU,UAAA;AAChBC,gBAAQD,MAAM,kCAAkCb,IAAI,KAAKa,KAAK;AACvD,eAAA;AAAA,MAAA,CACR;AAAA,IAAA,CACJ;AAGD,UAAMU,mBAAmB,MAAM9B,QAAQuB,IAAIK,iBAAiB;AAG3CtB,qBAAAA,QAAQ,CAACkB,QAAQhB,UAAU;AAC1C,UAAIgB,UAAUtB,QAAQM,KAAK,MAAM,MAAM;AACrCN,gBAAQM,KAAK,IAAIgB;AAAAA,MAAAA;AAAAA,IACnB,CACD;AAAA,WACMJ,OAAO;AACNA,YAAAA,MAAM,yCAAyCA,KAAK;AAAA,EAAA;AAI9D,aAAWZ,SAASH,iBAAiB;AAC/BH,QAAAA,QAAQM,KAAK,MAAM,MAAM;AAC3BN,cAAQM,KAAK,IAAIuB,6BACf1C,SAASmB,KAAK,CAChB;AAAA,IAAA;AAAA,EACF;AAGKN,SAAAA;AACT;"}