{"version":3,"file":"getName.js","sources":["../../../src/identity/utils/getName.ts"],"sourcesContent":["import type {\n  Basename,\n  GetNameParams,\n  GetNameReturnType,\n} from '@/identity/types';\nimport { base, mainnet } from 'viem/chains';\nimport { getChainPublicClient } from '../../core/network/getChainPublicClient';\nimport { isBase } from '../../core/utils/isBase';\nimport { isEthereum } from '../../core/utils/isEthereum';\nimport L2ResolverAbi from '../abis/L2ResolverAbi';\nimport { RESOLVER_ADDRESSES_BY_CHAIN_ID } from '../constants';\nimport { convertReverseNodeToBytes } from './convertReverseNodeToBytes';\nimport { getAddress } from './getAddress';\n\n/**\n * An asynchronous function to fetch the Ethereum Name Service (ENS)\n * name for a given Ethereum address. It returns the ENS name if it exists,\n * or null if it doesn't or in case of an error.\n */\nexport const getName = async ({\n  address,\n  chain = mainnet,\n}: GetNameParams): Promise<GetNameReturnType> => {\n  const chainIsBase = isBase({ chainId: chain.id });\n  const chainIsEthereum = isEthereum({ chainId: chain.id });\n  const chainSupportsUniversalResolver = chainIsEthereum || chainIsBase;\n\n  if (!chainSupportsUniversalResolver) {\n    return Promise.reject(\n      'ChainId not supported, name resolution is only supported on Ethereum and Base.',\n    );\n  }\n\n  if (!address) {\n    return null;\n  }\n\n  const client = getChainPublicClient(chain);\n\n  if (chainIsBase) {\n    const addressReverseNode = convertReverseNodeToBytes(address, base.id);\n    try {\n      const basename = (await client.readContract({\n        abi: L2ResolverAbi,\n        address: RESOLVER_ADDRESSES_BY_CHAIN_ID[chain.id],\n        functionName: 'name',\n        args: [addressReverseNode],\n      })) as Basename;\n\n      // Verify basename with forward resolution\n      if (basename) {\n        try {\n          const resolvedAddress = await getAddress({\n            name: basename,\n          });\n\n          if (\n            resolvedAddress &&\n            resolvedAddress.toLowerCase() === address.toLowerCase()\n          ) {\n            return basename;\n          }\n        } catch (error) {\n          console.error(\n            'Error during basename forward resolution verification:',\n            error,\n          );\n        }\n      }\n    } catch {\n      // This is a best effort attempt, so we don't need to do anything here.\n    }\n  }\n\n  // Default fallback to mainnet\n  // ENS resolution is not well-supported on Base, so want to ensure that we fall back to mainnet\n  const fallbackClient = getChainPublicClient(mainnet);\n\n  try {\n    // ENS username\n    const ensName = await fallbackClient.getEnsName({\n      address,\n    });\n\n    // Verify ENS name with forward resolution\n    if (ensName) {\n      try {\n        const resolvedAddress = await getAddress({\n          name: ensName,\n        });\n\n        if (\n          resolvedAddress &&\n          resolvedAddress.toLowerCase() === address.toLowerCase()\n        ) {\n          return ensName;\n        }\n      } catch (error) {\n        console.error(\n          'Error during ENS forward resolution verification:',\n          error,\n        );\n      }\n    }\n  } catch {\n    // This is a best effort attempt, so we don't need to do anything here.\n  }\n\n  return null;\n};\n"],"names":["getName","address","chain","mainnet","chainIsBase","isBase","chainId","id","chainIsEthereum","isEthereum","chainSupportsUniversalResolver","Promise","reject","client","getChainPublicClient","addressReverseNode","convertReverseNodeToBytes","base","basename","readContract","abi","L2ResolverAbi","RESOLVER_ADDRESSES_BY_CHAIN_ID","functionName","args","resolvedAddress","getAddress","name","toLowerCase","error","fallbackClient","ensName","getEnsName"],"mappings":";;;;;;;;AAmBO,MAAMA,UAAU,OAAO;AAAA,EAC5BC;AAAAA,EACAC,QAAQC;AACK,MAAkC;AAC/C,QAAMC,cAAcC,OAAO;AAAA,IAAEC,SAASJ,MAAMK;AAAAA,EAAAA,CAAI;AAChD,QAAMC,kBAAkBC,WAAW;AAAA,IAAEH,SAASJ,MAAMK;AAAAA,EAAAA,CAAI;AACxD,QAAMG,iCAAiCF,mBAAmBJ;AAE1D,MAAI,CAACM,gCAAgC;AAC5BC,WAAAA,QAAQC,OACb,gFACF;AAAA,EAAA;AAGF,MAAI,CAACX,SAAS;AACL,WAAA;AAAA,EAAA;AAGHY,QAAAA,SAASC,qBAAqBZ,KAAK;AAEzC,MAAIE,aAAa;AACf,UAAMW,qBAAqBC,0BAA0Bf,SAASgB,KAAKV,EAAE;AACjE,QAAA;AACIW,YAAAA,WAAY,MAAML,OAAOM,aAAa;AAAA,QAC1CC,KAAKC;AAAAA,QACLpB,SAASqB,+BAA+BpB,MAAMK,EAAE;AAAA,QAChDgB,cAAc;AAAA,QACdC,MAAM,CAACT,kBAAkB;AAAA,MAAA,CAC1B;AAGD,UAAIG,UAAU;AACR,YAAA;AACIO,gBAAAA,kBAAkB,MAAMC,WAAW;AAAA,YACvCC,MAAMT;AAAAA,UAAAA,CACP;AAED,cACEO,mBACAA,gBAAgBG,YAAkB3B,MAAAA,QAAQ2B,eAC1C;AACOV,mBAAAA;AAAAA,UAAAA;AAAAA,iBAEFW,OAAO;AACNA,kBAAAA,MACN,0DACAA,KACF;AAAA,QAAA;AAAA,MACF;AAAA,IACF,QACM;AAAA,IAAA;AAAA,EACN;AAMEC,QAAAA,iBAAiBhB,qBAAqBX,OAAO;AAE/C,MAAA;AAEI4B,UAAAA,UAAU,MAAMD,eAAeE,WAAW;AAAA,MAC9C/B;AAAAA,IAAAA,CACD;AAGD,QAAI8B,SAAS;AACP,UAAA;AACIN,cAAAA,kBAAkB,MAAMC,WAAW;AAAA,UACvCC,MAAMI;AAAAA,QAAAA,CACP;AAED,YACEN,mBACAA,gBAAgBG,YAAkB3B,MAAAA,QAAQ2B,eAC1C;AACOG,iBAAAA;AAAAA,QAAAA;AAAAA,eAEFF,OAAO;AACNA,gBAAAA,MACN,qDACAA,KACF;AAAA,MAAA;AAAA,IACF;AAAA,EACF,QACM;AAAA,EAAA;AAID,SAAA;AACT;"}