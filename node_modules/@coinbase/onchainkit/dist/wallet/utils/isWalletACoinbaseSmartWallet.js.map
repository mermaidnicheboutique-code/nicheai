{"version":3,"file":"isWalletACoinbaseSmartWallet.js","sources":["../../../src/wallet/utils/isWalletACoinbaseSmartWallet.ts"],"sourcesContent":["import { checksumAddress, decodeAbiParameters } from 'viem';\nimport type {\n  Address,\n  BlockTag,\n  Hex,\n  PublicClient,\n  RpcUserOperation,\n} from 'viem';\nimport {\n  CB_SW_FACTORY_ADDRESS,\n  CB_SW_PROXY_BYTECODE,\n  CB_SW_V1_IMPLEMENTATION_ADDRESS,\n  ERC_1967_PROXY_IMPLEMENTATION_SLOT,\n} from '../constants';\n\nexport type IsWalletACoinbaseSmartWalletOptions = {\n  client: PublicClient;\n  userOp: RpcUserOperation<'0.6'>;\n};\n\nexport type IsWalletACoinbaseSmartWalletResponse =\n  | { isCoinbaseSmartWallet: true }\n  | { isCoinbaseSmartWallet: false; error: string; code: string };\n\n/**\n * Validates a User Operation by checking if the sender address\n * is a proxy with the expected bytecode.\n */\nexport async function isWalletACoinbaseSmartWallet({\n  client,\n  userOp,\n}: IsWalletACoinbaseSmartWalletOptions): Promise<IsWalletACoinbaseSmartWalletResponse> {\n  try {\n    const code = await client.getBytecode({ address: userOp.sender });\n\n    if (!code) {\n      // no code at address, check that the initCode is deploying a Coinbase Smart Wallet\n      // factory address is first 20 bytes of initCode after '0x'\n      const factoryAddress = userOp?.initCode?.slice(0, 42) as Address;\n      if (\n        checksumAddress(factoryAddress) !==\n        checksumAddress(CB_SW_FACTORY_ADDRESS)\n      ) {\n        return {\n          isCoinbaseSmartWallet: false,\n          error: 'Invalid factory address',\n          code: 'W_ERR_1',\n        };\n      }\n      return { isCoinbaseSmartWallet: true };\n    }\n\n    // Verify if the sender address bytecode matches the Coinbase Smart Wallet proxy bytecode\n    if (code !== CB_SW_PROXY_BYTECODE) {\n      return {\n        isCoinbaseSmartWallet: false,\n        error: 'Invalid bytecode',\n        code: 'W_ERR_2',\n      };\n    }\n  } catch (error) {\n    console.error('Error retrieving bytecode:', error);\n    return {\n      isCoinbaseSmartWallet: false,\n      error: 'Error retrieving bytecode',\n      code: 'W_ERR_3',\n    };\n  }\n\n  let implementation: Hex;\n  try {\n    implementation = await client.request<{\n      Parameters: [Address, Hex, BlockTag];\n      ReturnType: Hex;\n    }>({\n      method: 'eth_getStorageAt',\n      params: [userOp.sender, ERC_1967_PROXY_IMPLEMENTATION_SLOT, 'latest'],\n    });\n  } catch (error) {\n    console.error('Error retrieving implementation address:', error);\n    return {\n      isCoinbaseSmartWallet: false,\n      error: 'Error retrieving implementation address',\n      code: 'W_ERR_4',\n    };\n  }\n\n  // Decode the implementation address from the retrieved storage data\n  const implementationAddress = decodeAbiParameters(\n    [{ type: 'address' }],\n    implementation,\n  )[0];\n\n  // Verify if the implementation address matches the expected Coinbase Smart Wallet address\n  if (\n    checksumAddress(implementationAddress) !==\n    checksumAddress(CB_SW_V1_IMPLEMENTATION_ADDRESS)\n  ) {\n    return {\n      isCoinbaseSmartWallet: false,\n      error: 'Invalid implementation address',\n      code: 'W_ERR_5',\n    };\n  }\n\n  return { isCoinbaseSmartWallet: true };\n}\n"],"names":["isWalletACoinbaseSmartWallet","client","userOp","code","getBytecode","address","sender","factoryAddress","initCode","slice","checksumAddress","CB_SW_FACTORY_ADDRESS","isCoinbaseSmartWallet","error","CB_SW_PROXY_BYTECODE","implementation","request","method","params","ERC_1967_PROXY_IMPLEMENTATION_SLOT","implementationAddress","decodeAbiParameters","type","CB_SW_V1_IMPLEMENTATION_ADDRESS"],"mappings":";;AA4BA,eAAsBA,6BAA6B;AAAA,EACjDC;AAAAA,EACAC;AACmC,GAAkD;;AACjF,MAAA;AACIC,UAAAA,OAAO,MAAMF,OAAOG,YAAY;AAAA,MAAEC,SAASH,OAAOI;AAAAA,IAAAA,CAAQ;AAEhE,QAAI,CAACH,MAAM;AAGT,YAAMI,kBAAiBL,sCAAQM,aAARN,mBAAkBO,MAAM,GAAG;AAClD,UACEC,gBAAgBH,cAAc,MAC9BG,gBAAgBC,qBAAqB,GACrC;AACO,eAAA;AAAA,UACLC,uBAAuB;AAAA,UACvBC,OAAO;AAAA,UACPV,MAAM;AAAA,QACR;AAAA,MAAA;AAEK,aAAA;AAAA,QAAES,uBAAuB;AAAA,MAAK;AAAA,IAAA;AAIvC,QAAIT,SAASW,sBAAsB;AAC1B,aAAA;AAAA,QACLF,uBAAuB;AAAA,QACvBC,OAAO;AAAA,QACPV,MAAM;AAAA,MACR;AAAA,IAAA;AAAA,WAEKU,OAAO;AACNA,YAAAA,MAAM,8BAA8BA,KAAK;AAC1C,WAAA;AAAA,MACLD,uBAAuB;AAAA,MACvBC,OAAO;AAAA,MACPV,MAAM;AAAA,IACR;AAAA,EAAA;AAGEY,MAAAA;AACA,MAAA;AACe,qBAAA,MAAMd,OAAOe,QAG3B;AAAA,MACDC,QAAQ;AAAA,MACRC,QAAQ,CAAChB,OAAOI,QAAQa,oCAAoC,QAAQ;AAAA,IAAA,CACrE;AAAA,WACMN,OAAO;AACNA,YAAAA,MAAM,4CAA4CA,KAAK;AACxD,WAAA;AAAA,MACLD,uBAAuB;AAAA,MACvBC,OAAO;AAAA,MACPV,MAAM;AAAA,IACR;AAAA,EAAA;AAIIiB,QAAAA,wBAAwBC,oBAC5B,CAAC;AAAA,IAAEC,MAAM;AAAA,EAAA,CAAW,GACpBP,cACF,EAAE,CAAC;AAGH,MACEL,gBAAgBU,qBAAqB,MACrCV,gBAAgBa,+BAA+B,GAC/C;AACO,WAAA;AAAA,MACLX,uBAAuB;AAAA,MACvBC,OAAO;AAAA,MACPV,MAAM;AAAA,IACR;AAAA,EAAA;AAGK,SAAA;AAAA,IAAES,uBAAuB;AAAA,EAAK;AACvC;"}