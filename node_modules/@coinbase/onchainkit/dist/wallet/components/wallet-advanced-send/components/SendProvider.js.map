{"version":3,"file":"SendProvider.js","sources":["../../../../../src/wallet/components/wallet-advanced-send/components/SendProvider.tsx"],"sourcesContent":["import type { PortfolioTokenWithFiatValue } from '@/api/types';\nimport { RequestContext } from '@/core/network/constants';\nimport { useLifecycleStatus } from '@/internal/hooks/useLifecycleStatus';\nimport { usePriceQuote } from '@/internal/hooks/usePriceQuote';\nimport { useValue } from '@/internal/hooks/useValue';\nimport { isApiError } from '@/internal/utils/isApiResponseError';\nimport { truncateDecimalPlaces } from '@/internal/utils/truncateDecimalPlaces';\nimport {\n  createContext,\n  useCallback,\n  useContext,\n  useEffect,\n  useMemo,\n  useState,\n} from 'react';\nimport { formatUnits } from 'viem';\nimport { useAccount } from 'wagmi';\nimport { usePortfolio } from '../../../hooks/usePortfolio';\nimport type {\n  SendContextType,\n  SendLifecycleStatus,\n  SendProviderReact,\n} from '../types';\nimport { useRecipientState } from '../hooks/useRecipientState';\n\nconst emptyContext = {} as SendContextType;\n\nconst SendContext = createContext(emptyContext);\n\nexport function useSendContext() {\n  const sendContext = useContext(SendContext);\n  if (sendContext === emptyContext) {\n    throw new Error('useSendContext must be used within a SendProvider');\n  }\n  return sendContext;\n}\n\nexport function SendProvider({ children }: SendProviderReact) {\n  // state for token selection\n  const [selectedToken, setSelectedToken] =\n    useState<PortfolioTokenWithFiatValue | null>(null);\n  const [selectedInputType, setSelectedInputType] = useState<'fiat' | 'crypto'>(\n    'crypto',\n  );\n  const [fiatAmount, setFiatAmount] = useState<string | null>(null);\n  const [cryptoAmount, setCryptoAmount] = useState<string | null>(null);\n\n  const {\n    recipientState,\n    updateRecipientInput,\n    validateRecipientInput,\n    selectRecipient,\n    deselectRecipient,\n  } = useRecipientState();\n\n  // lifecycle status\n  const [lifecycleStatus, updateLifecycleStatus] =\n    useLifecycleStatus<SendLifecycleStatus>({\n      statusName: 'init',\n      statusData: {\n        isMissingRequiredField: true,\n      },\n    });\n\n  const hasSufficientBalance = useMemo(() => {\n    if (!selectedToken) {\n      return false;\n    }\n\n    if (selectedInputType === 'fiat') {\n      return Number(fiatAmount) <= selectedToken.fiatBalance;\n    }\n\n    return (\n      Number(cryptoAmount) <=\n      Number(\n        formatUnits(\n          BigInt(selectedToken.cryptoBalance),\n          selectedToken.decimals,\n        ),\n      )\n    );\n  }, [selectedInputType, selectedToken, cryptoAmount, fiatAmount]);\n\n  // fetch & set ETH balance\n  const { address } = useAccount();\n  const { data: portfolioData } = usePortfolio(\n    { address },\n    RequestContext.Wallet,\n  );\n  const ethHolding = portfolioData?.tokenBalances?.find(\n    (token) => token.address === '',\n  );\n  const ethBalance = ethHolding\n    ? Number(formatUnits(BigInt(ethHolding.cryptoBalance), ethHolding.decimals))\n    : 0;\n  const isInitialized = ethBalance !== undefined;\n\n  useEffect(() => {\n    if (!ethBalance || ethBalance === 0) {\n      updateLifecycleStatus({\n        statusName: 'fundingWallet',\n        statusData: {\n          isMissingRequiredField: true,\n        },\n      });\n      return;\n    }\n\n    updateLifecycleStatus({\n      statusName: 'selectingAddress',\n      statusData: {\n        isMissingRequiredField: true,\n      },\n    });\n  }, [ethBalance, updateLifecycleStatus]);\n\n  // fetch & set exchange rate\n  const { isLoading: exchangeRateLoading, data: exchangeRateData } =\n    usePriceQuote(\n      {\n        token: selectedToken?.address === '' ? 'ETH' : selectedToken?.address,\n      },\n      RequestContext.Wallet,\n    );\n  const exchangeRate = useMemo(() => {\n    if (\n      !exchangeRateData ||\n      isApiError(exchangeRateData) ||\n      exchangeRateData.priceQuotes.length === 0\n    ) {\n      return 0;\n    }\n\n    return 1 / Number(exchangeRateData.priceQuotes[0].price);\n  }, [exchangeRateData]);\n\n  const handleTokenSelection = useCallback(\n    (token: PortfolioTokenWithFiatValue) => {\n      setSelectedToken(token);\n      updateLifecycleStatus({\n        statusName: 'amountChange',\n        statusData: {\n          isMissingRequiredField: true,\n          sufficientBalance: false,\n        },\n      });\n    },\n    [updateLifecycleStatus],\n  );\n\n  const handleResetTokenSelection = useCallback(() => {\n    setSelectedToken(null);\n    setFiatAmount(null);\n    setCryptoAmount(null);\n    updateLifecycleStatus({\n      statusName: 'selectingToken',\n      statusData: {\n        isMissingRequiredField: true,\n      },\n    });\n  }, [updateLifecycleStatus]);\n\n  const handleFiatAmountChange = useCallback(\n    (value: string) => {\n      setFiatAmount(value);\n      updateLifecycleStatus({\n        statusName: 'amountChange',\n        statusData: {\n          isMissingRequiredField: true,\n          sufficientBalance: hasSufficientBalance,\n        },\n      });\n    },\n    [updateLifecycleStatus, hasSufficientBalance],\n  );\n\n  const handleCryptoAmountChange = useCallback(\n    (value: string) => {\n      const truncatedValue = truncateDecimalPlaces(value, 8);\n      setCryptoAmount(truncatedValue);\n      updateLifecycleStatus({\n        statusName: 'amountChange',\n        statusData: {\n          isMissingRequiredField: true,\n          sufficientBalance: hasSufficientBalance,\n        },\n      });\n    },\n    [updateLifecycleStatus, hasSufficientBalance],\n  );\n\n  const value = useValue<SendContextType>({\n    isInitialized,\n    lifecycleStatus,\n    updateLifecycleStatus,\n    ethBalance,\n    recipientState,\n    updateRecipientInput,\n    validateRecipientInput,\n    selectRecipient,\n    deselectRecipient,\n    selectedToken,\n    handleTokenSelection,\n    handleResetTokenSelection,\n    fiatAmount,\n    handleFiatAmountChange,\n    cryptoAmount,\n    handleCryptoAmountChange,\n    exchangeRate,\n    exchangeRateLoading,\n    selectedInputType,\n    setSelectedInputType,\n  });\n\n  return <SendContext.Provider value={value}>{children}</SendContext.Provider>;\n}\n"],"names":["emptyContext","SendContext","createContext","useSendContext","sendContext","useContext","Error","SendProvider","children","selectedToken","setSelectedToken","useState","selectedInputType","setSelectedInputType","fiatAmount","setFiatAmount","cryptoAmount","setCryptoAmount","recipientState","updateRecipientInput","validateRecipientInput","selectRecipient","deselectRecipient","useRecipientState","lifecycleStatus","updateLifecycleStatus","useLifecycleStatus","statusName","statusData","isMissingRequiredField","hasSufficientBalance","useMemo","Number","fiatBalance","formatUnits","BigInt","cryptoBalance","decimals","address","useAccount","data","portfolioData","usePortfolio","RequestContext","Wallet","ethHolding","tokenBalances","find","token","ethBalance","isInitialized","undefined","useEffect","isLoading","exchangeRateLoading","exchangeRateData","usePriceQuote","exchangeRate","isApiError","priceQuotes","length","price","handleTokenSelection","useCallback","sufficientBalance","handleResetTokenSelection","handleFiatAmountChange","value","handleCryptoAmountChange","truncatedValue","truncateDecimalPlaces","useValue"],"mappings":"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"}