{"version":3,"file":"useAuthenticate.js","sources":["../../../src/minikit/hooks/useAuthenticate.ts"],"sourcesContent":["import sdk from '@farcaster/miniapp-sdk';\nimport type { SignIn as SignInCore } from '@farcaster/miniapp-sdk';\nimport { useCallback } from 'react';\nimport { useMiniKit } from './useMiniKit';\n\ntype ParsedSignInMessage = {\n  address: string;\n  chainID: string;\n  domain: string;\n  issuedAt: string;\n  nonce: string;\n  resources: string[];\n  uri: string;\n  version: string;\n};\n\n/**\n * Parse the sign in message\n * @param message - The sign in message to parse\n * @returns {ParsedSignInMessage} - The parsed sign in message\n */\nexport function parseSignInMessage(message: string): ParsedSignInMessage {\n  const [domainLine, address, ...rest] = message.split('\\n');\n  const [domain] = domainLine.split(\n    ' wants you to sign in with your Ethereum account:',\n  );\n\n  const parsedData: ParsedSignInMessage = {\n    domain,\n    address,\n    chainID: '',\n    issuedAt: '',\n    nonce: '',\n    resources: [],\n    uri: '',\n    version: '',\n  };\n\n  return rest.reduce((acc, line) => {\n    if (line.includes(': ')) {\n      const [key, value] = line.split(': ');\n      const camelKey = key.replace(/^([^\\s]+)(?:\\s+)?/, (_, firstWord) =>\n        firstWord.toLowerCase(),\n      );\n      acc[camelKey as keyof Omit<ParsedSignInMessage, 'resources'>] = value;\n      return acc;\n    }\n\n    if (line.startsWith('- ')) {\n      acc.resources.push(line.slice(2));\n      return acc;\n    }\n\n    return acc;\n  }, parsedData);\n}\n\ntype ValidateSignInMessageProps = {\n  message: string;\n  domain?: string;\n  fid?: number;\n  nonce?: string;\n};\n\n/**\n * Validate the sign in message\n * @param message - The sign in message to validate\n * @param domain [optional] - The domain of the frame to validate against, if not provided, the domain will not be validated\n * @param fid [optional] - The fid of the frame to validate against, if not provided, the fid will not be validated\n * @param nonce [optional] - The nonce to validate against, if not provided, the nonce will not be validated\n * @returns void\n */\nfunction validateSignInMessage({\n  message,\n  domain,\n  fid,\n  nonce,\n}: ValidateSignInMessageProps) {\n  const parsed = parseSignInMessage(message);\n  if (domain) {\n    const domainUrlObj = new URL(domain);\n\n    // domain in message should match frame's domain\n    if (domainUrlObj.hostname !== parsed.domain) {\n      throw new Error('Domain mismatch');\n    }\n  }\n\n  // validate nonce\n  if (nonce && parsed.nonce !== nonce) {\n    throw new Error('Nonce mismatch');\n  }\n\n  // validate fid\n  if (fid) {\n    const fidRegex = new RegExp(`^farcaster://fid/${fid}$`);\n    const fidMatch = parsed.resources.find((resource) =>\n      fidRegex.test(resource),\n    );\n    if (!fidMatch) {\n      throw new Error('Fid mismatch');\n    }\n  }\n}\n\n/**\n * Generates a cryptographically secure random nonce string.\n * Uses the Web Crypto API to create random values that are then converted to a base-36 string.\n *\n * @param length - The length of the nonce to generate in bytes. Defaults to 8 bytes.\n * @returns A random string of base-36 characters (0-9, a-z) derived from the random bytes.\n */\nfunction generateSecureNonce(length = 8): string {\n  const array = new Uint8Array(length);\n  crypto.getRandomValues(array);\n  return Array.from(array)\n    .map((val) => (val % 36).toString(36))\n    .join('');\n}\n\ntype UseAuthenticateProps = Omit<SignInCore.SignInOptions, 'nonce'> & {\n  nonce?: string;\n};\n\n/**\n * Authenticates the user's account.\n * @param domain [optional] - The domain of the frame to authenticate against, if not provided, the domain will not be validated\n * @param skipValidation [optional] - Whether to skip validation of the nonce and fid, by default it will validate the nonce and fid\n * @returns `signIn` - A function that wraps the frames SDK signIn action and returns the result of the signIn action\n */\nexport const useAuthenticate = (domain?: string, skipValidation = false) => {\n  const { context } = useMiniKit();\n\n  const signIn = useCallback(\n    async (signInOptions: UseAuthenticateProps = {}) => {\n      try {\n        if (!signInOptions?.nonce) {\n          signInOptions.nonce = generateSecureNonce();\n        }\n        const result = await sdk.actions.signIn(\n          signInOptions as SignInCore.SignInOptions,\n        );\n        if (!skipValidation) {\n          validateSignInMessage({\n            message: result.message,\n            domain,\n            fid: context?.user?.fid,\n            nonce: signInOptions.nonce,\n          });\n        }\n\n        return result;\n      } catch (error) {\n        console.error(error);\n        return false;\n      }\n    },\n    [context?.user?.fid, domain, skipValidation],\n  );\n\n  return { signIn };\n};\n"],"names":["parseSignInMessage","message","domainLine","address","rest","split","domain","parsedData","chainID","issuedAt","nonce","resources","uri","version","reduce","acc","line","includes","key","value","camelKey","replace","_","firstWord","toLowerCase","startsWith","push","slice","validateSignInMessage","fid","parsed","domainUrlObj","URL","hostname","Error","fidRegex","RegExp","fidMatch","find","resource","test","generateSecureNonce","length","array","Uint8Array","crypto","getRandomValues","Array","from","map","val","toString","join","useAuthenticate","skipValidation","context","useMiniKit","signIn","useCallback","signInOptions","result","sdk","actions","user","error","console"],"mappings":"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"}